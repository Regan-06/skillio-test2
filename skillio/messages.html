<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Skillio Messages | skillio.site</title>

  <!-- Google Analytics (replace ID in production) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-XXXXXXXXXX"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'G-XXXXXXXXXX');
  </script>

  <!-- Firebase compat SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>

  <style>
    :root{
      --bg:#c9f2f5; --ink:#0f2027; --brand:#00bcd4; --brand-d:#0097a7; --card:#ffffff;
      --muted:#666; --radius:12px; --shadow:0 8px 20px rgba(0, 188, 212, 0.2);
    }
    *{box-sizing:border-box}
    body { margin: 0; font-family: 'Segoe UI', sans-serif; background-color: var(--bg); color: var(--ink); padding: 30px; }
    nav { background-color: var(--brand); padding: 12px 20px; border-radius: var(--radius); margin-bottom: 30px;
          display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px; box-shadow: 0 4px 12px rgba(0, 188, 212, 0.3); }
    nav img { height: 64px; border-radius: 10px; display:block }
    .top-nav-links { display: flex; gap: 20px; flex-wrap: wrap; justify-content: center; }
    nav a { color: white; text-decoration: none; font-weight: bold; font-size: 1rem; transition: opacity 0.2s; }
    nav a:hover { opacity: .9 }
    h1 { text-align: center; color: var(--brand); margin: 6px 0 10px; }
    .note { text-align: center; margin: 0 auto 22px; font-size: 0.95rem; color: #555; background: #fff3cd; padding: 10px; border-radius: 10px; border: 1px solid #ffeeba; max-width: 900px; }

    .layout { display:grid; grid-template-columns: 320px 1fr; gap: 16px; align-items: start; }
    @media (max-width: 900px){ .layout{ grid-template-columns: 1fr; } }

    .conversations { background: var(--card); padding: 14px; border-radius: var(--radius); box-shadow: var(--shadow); min-height: 200px; }
    .conversation { padding: 12px; border-radius: 10px; cursor: pointer; display: grid; grid-template-columns: 44px 1fr; gap: 12px; align-items: center; }
    .conversation + .conversation { margin-top: 6px; }
    .conversation:hover { background-color: #f1fafd; }
    .profile-pic { width: 44px; height: 44px; border-radius: 50%; object-fit: cover; object-position: center; border: 2px solid var(--brand); flex-shrink: 0; display: block; }
    .conversation small { color: var(--muted) }

    .chat { background: var(--card); padding: 14px; border-radius: var(--radius); box-shadow: var(--shadow); min-height: 400px; }
    #messages { max-height: 60vh; overflow-y: auto; padding: 6px; }
    .message { margin-bottom: 12px; }
    .bubble { padding: 10px 12px; border-radius: 12px; display: inline-block; max-width: 80%; }
    .bubble.mine { background: #007bff; color: #fff; }
    .bubble.their { background: #e9ecef; color: #111; }
    .meta { font-size: 12px; color: var(--muted); margin-top: 4px }
    .composer { display:flex; gap: 8px; margin-top: 10px; }
    .composer input { flex:1; padding: 10px; border-radius: 10px; border: 1px solid #ccc; font-size: 1rem; min-width: 0; }
    .composer button { padding: 10px 16px; background-color: var(--brand); border: none; color: white; border-radius: 10px; cursor: pointer; font-size: 1rem; }
    .composer button:hover { background-color: var(--brand-d); }

    .actions { display:flex; gap:8px; flex-wrap:wrap; margin: 10px 0 4px; }
    .pill { border:none; background:#e0f7fa; color:#006064; padding:8px 12px; border-radius: 999px; cursor:pointer; }

    .swap-button { background-color: var(--brand); color: white; padding: 8px 16px; border: none; border-radius: 8px; margin-top: 8px; cursor: pointer; }

    /* Modal */
    .modal { display:none; position: fixed; z-index: 1000; inset: 0; background-color: rgba(0,0,0,0.5); }
    .modal-content { background-color: #fefefe; margin: 5% auto; padding: 0; border-radius: 12px; width: 90%; max-width: 420px; max-height: 80vh; box-shadow: 0 4px 20px rgba(0,0,0,0.3); overflow-y: auto; }
    .modal-header { background: var(--brand); color: white; padding: 16px 20px; border-radius: 12px 12px 0 0; font-size: 18px; font-weight: bold; position: sticky; top: 0; z-index: 1; }
    .modal-body { padding: 16px 20px; }
    .form-group { margin-bottom: 14px; }
    .form-group label { display:block; margin-bottom: 6px; font-weight: 600; }
    .form-group input, .form-group select { width:100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 16px; }
    .modal-footer { padding: 14px 20px 18px; display: flex; gap: 10px; position: sticky; bottom: 0; background: #fff; border-top: 1px solid #eee; border-radius: 0 0 12px 12px; }
    .btn { flex: 1; padding: 12px; border: none; border-radius: 8px; font-size: 16px; cursor: pointer; }
    .btn-cancel { background:#f0f0f0; color:#666 }
    .btn-cancel:hover { background:#e0e0e0 }
    .btn-create { background: var(--brand); color:#fff }
    .btn-create:hover { background: var(--brand-d) }

    @media (prefers-reduced-motion: reduce){ *{ animation:none!important; transition:none!important } }
  </style>
</head>
<body>
  <nav>
    <a href="main.html"><img src="skillio/skillio logo.png" alt="Skillio Logo" /></a>
    <div class="top-nav-links">
      <a href="profile.html">Profile</a>
      <a href="messages.html" aria-current="page">Messages</a>
      <a href="#" onclick="firebase.auth().signOut().then(()=>window.location.href='auth.html')">Logout</a>
    </div>
  </nav>

  <h1>Your Conversations</h1>
  <p class="note">ðŸ’¬ Arrange swaps right here. Propose a time with one tap, or open the form for more details. Keep it simple!</p>

  <div class="layout">
    <aside class="conversations" id="conversationList">Loading conversations...</aside>
    <section class="chat">
      <div id="messages">Select a conversation to view messages</div>
      <div class="actions" id="quickActions" style="display:none"></div>
      <form class="composer" id="composer" style="display:none">
        <input type="text" id="messageInput" placeholder="Type your message..." required />
        <button type="submit" id="sendBtn">Send</button>
      </form>
      <button class="swap-button" id="swapBtn" style="display:none">Set Up Swap</button>
    </section>
  </div>

  <!-- Modal root -->
  <div class="modal" id="modalRoot"></div>

  <script>
    // --- Firebase init ---
    const firebaseConfig = {
      apiKey: "AIzaSyCTnKPEvdxkJnn2041wT-2io3jU6D-vQrw",
      authDomain: "skillio-b2f44.firebaseapp.com",
      projectId: "skillio-b2f44",
      storageBucket: "skillio-b2f44.appspot.com",
      messagingSenderId: "883002535621",
      appId: "1:883002535621:web:f3efb6d41389fbd91c8aac"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();

    // --- Helpers ---
    function makeConversationId(a,b){ return [a,b].sort().join('_'); }
    function qs(q){ return document.querySelector(q); }
    function getQueryParam(param){ const urlParams = new URLSearchParams(window.location.search); return urlParams.get(param); }

    // --- State ---
    let currentUserId = null;
    let currentUserData = null;
    let currentConversationUserId = null;
    let targetUserData = null;
    let unsubscribeMessages = null;

    auth.onAuthStateChanged(async (user)=>{
      if(!user){ window.location.href = 'auth.html'; return; }
      currentUserId = user.uid;
      // load self
      try{ const snap = await db.collection('users').doc(currentUserId).get(); currentUserData = snap.data()||{}; }catch(e){ console.warn(e); }
      await loadConversationList();

      const targetUserId = getQueryParam('user');
      if(targetUserId && targetUserId !== currentUserId){ openConversation(targetUserId); }
    });

    async function loadConversationList(){
      const listEl = qs('#conversationList');
      listEl.innerHTML = 'Loading conversations...';
      try{
        // Prefer a single query using participants array
        let recent = null;
        try{
          recent = await db.collection('messages')
            .where('participants', 'array-contains', currentUserId)
            .orderBy('timestamp','desc')
            .limit(100)
            .get();
        }catch(_e){ /* index may be missing; fallback below */ }

        const partners = new Map();
        if(recent && !recent.empty){
          recent.forEach(doc=>{
            const m = doc.data();
            const other = (m.from === currentUserId) ? m.to : m.from;
            if(!other) return;
            if(!partners.has(other)) partners.set(other, m.timestamp?.toDate()?.getTime() || 0);
          });
        } else {
          // Fallback: two queries
          const [sent, received] = await Promise.all([
            db.collection('messages').where('from','==', currentUserId).orderBy('timestamp','desc').limit(50).get(),
            db.collection('messages').where('to','==', currentUserId).orderBy('timestamp','desc').limit(50).get()
          ]);
          sent.docs.forEach(d=> partners.set(d.data().to, d.data().timestamp?.toDate()?.getTime()||0));
          received.docs.forEach(d=> partners.set(d.data().from, d.data().timestamp?.toDate()?.getTime()||0));
        }

        if(partners.size === 0){ listEl.innerHTML = '<p>No conversations yet.</p>'; return; }
        listEl.innerHTML = '';

        for(const [userId] of partners){
          let userName = 'User ' + userId.substring(0,8);
          let profilePic = 'default_profile.jpg';
          try{
            const udoc = await db.collection('users').doc(userId).get();
            if(udoc.exists){ const u = udoc.data(); userName = u.displayName || u.name || userName; profilePic = u.profilePic || profilePic; }
          }catch(e){ console.warn('user fetch', e); }

          const row = document.createElement('div');
          row.className = 'conversation';
          row.innerHTML = `<img src="${profilePic}" class="profile-pic" alt="${userName}"><div><strong>${userName}</strong><br><small>Click to open chat</small></div>`;
          row.onclick = ()=> openConversation(userId);
          listEl.appendChild(row);
        }
      }catch(err){
        console.error('loadConversationList', err); listEl.innerHTML = '<p>Error loading conversations.</p>';
      }
    }

    async function openConversation(targetUserId){
      currentConversationUserId = targetUserId;
      const messagesEl = qs('#messages');
      const quickEl = qs('#quickActions');
      const composerEl = qs('#composer');
      const swapBtn = qs('#swapBtn');

      messagesEl.innerHTML = 'Loading chat...';
      quickEl.style.display = 'none';
      composerEl.style.display = 'none';
      swapBtn.style.display = 'none';

      // load target user data
      try{
        const tdoc = await db.collection('users').doc(targetUserId).get();
        targetUserData = tdoc.data()||{};
      }catch(e){ targetUserData = {}; }

      const convoId = makeConversationId(currentUserId, targetUserId);

      if(unsubscribeMessages) unsubscribeMessages();

      unsubscribeMessages = db.collection('messages')
        .where('conversationId','==', convoId)
        .orderBy('timestamp','asc')
        .onSnapshot(async snap=>{
          const msgs = [];
          for(const doc of snap.docs){
            const data = { id: doc.id, ...doc.data() };
            if(data.type === 'swap_request' && data.swapId){
              try{ const sdoc = await db.collection('swaps').doc(data.swapId).get(); if(sdoc.exists) data.swapData = sdoc.data(); }catch(e){ console.warn(e); }
            }
            msgs.push(data);
          }
          renderConversation(messagesEl, msgs);
          markMessagesAsRead(msgs.filter(m=> m.to === currentUserId && !m.read));

          renderQuickActions(quickEl); quickEl.style.display = 'flex';
          setupComposer(composerEl); composerEl.style.display = 'flex';
          const theirName = targetUserData?.displayName || targetUserData?.name || ('User ' + targetUserId.substring(0,8));
          swapBtn.onclick = ()=> openSwapModal(targetUserId, theirName);
          swapBtn.style.display = 'inline-block';
        }, err=>{
          console.error('onSnapshot', err); messagesEl.innerHTML = '<div style="color:red">Error loading messages</div>';
        });
    }

    function renderConversation(container, messages){
      container.innerHTML = '';
      const myPic = currentUserData?.profilePic || 'default_profile.jpg';
      const theirPic = targetUserData?.profilePic || 'default_profile.jpg';
      const theirName = targetUserData?.displayName || targetUserData?.name || 'User';
      const myName = currentUserData?.displayName || currentUserData?.name || 'You';

      messages.forEach(m=>{
        const wrap = document.createElement('div'); wrap.className = 'message';
        if(m.type === 'swap_request'){
          wrap.appendChild(renderSwapCard(m));
        }else if(m.type === 'swap_response'){
          const bg = (m.response === 'accepted') ? '#d4edda' : '#f8d7da';
          const border = (m.response === 'accepted') ? '#c3e6cb' : '#f5c6cb';
          wrap.innerHTML = `
            <div style="background:${bg}; border:1px solid ${border}; border-radius:10px; padding:12px;">
              <strong>Swap ${m.response === 'accepted' ? 'Accepted' : 'Declined'}</strong>
              <div class="meta">${m.timestamp ? new Date(m.timestamp.toDate()).toLocaleString() : ''}</div>
              <div style="margin-top:6px">${m.text || ''}</div>
            </div>`;
        }else{
          const mine = m.from === currentUserId;
          wrap.innerHTML = `
            <div style="display:flex; align-items:flex-start; gap:10px; ${mine?'flex-direction:row-reverse':''}">
              <img src="${mine?myPic:theirPic}" alt="avatar" class="profile-pic" style="width:40px;height:40px;border:0"/>
              <div>
                <div class="bubble ${mine?'mine':'their'}">${(m.text || m.message || '').replace(/</g,'&lt;')}</div>
                <div class="meta">${mine?myName:theirName} Â· ${m.timestamp? new Date(m.timestamp.toDate()).toLocaleString():''}</div>
              </div>
            </div>`;
        }
        container.appendChild(wrap);
      });
      container.scrollTop = container.scrollHeight;
    }

    function renderSwapCard(message){
      const s = message.swapData || {};
      const start = s.startTime?.toDate ? s.startTime.toDate() : null;
      const minutes = s.duration_mins || 60;
      const paid = s.swap_type === 'paid';
      const price = (s.price_cents||0)/100;
      const status = s.status || 'proposed';
      const canRespond = (s.to === currentUserId && status === 'proposed');
      const canComplete = (status === 'confirmed' && start && new Date() >= start);

      const card = document.createElement('div');
      card.style.cssText = 'background:#f8f9fa;border:1px solid #e9ecef;border-radius:10px;padding:12px;';
      card.setAttribute('data-swap-id', message.swapId);

      card.innerHTML = `
        <div style=\"display:flex; justify-content:space-between; align-items:center; margin-bottom:6px;\">
          <strong>Swap Request ${paid?`- $${price}`:''}</strong>
          <span class=\"meta\">${message.timestamp ? new Date(message.timestamp.toDate()).toLocaleString() : ''}</span>
        </div>
        <div style=\"margin-bottom:8px; line-height:1.5\">
          <div><strong>What:</strong> ${s.description || 'Session'}</div>
          <div><strong>When:</strong> ${start? start.toLocaleString(): 'â€”'} (${minutes} min)</div>
          <div><strong>Mode:</strong> ${s.mode === 'in_person' ? `In person${s.location? ' Â· '+s.location:''}` : 'Online'}</div>
          <div><strong>Status:</strong> ${status}</div>
        </div>
        <div style=\"display:flex; gap:8px; flex-wrap:wrap;\">
          ${canRespond ? `
            <button onclick=\"respondToSwap('${message.swapId}','accepted')\" class=\"pill\" style=\"background:#28a745;color:#fff\">Accept</button>
            <button onclick=\"respondToSwap('${message.swapId}','declined')\" class=\"pill\" style=\"background:#dc3545;color:#fff\">Decline</button>
            <button onclick=\"suggestAnotherTime('${message.swapId}','${s.from}','${s.fromName||''}')\" class=\"pill\">Suggest another time</button>
          `: ''}
          ${canComplete ? `
            <button onclick=\"completeSwap('${message.swapId}')\" class=\"pill\" style=\"background:#28a745;color:#fff\">Mark completed</button>
            <button onclick=\"flagNoShow('${message.swapId}')\" class=\"pill\" style=\"background:#ff7043;color:#fff\">Didnâ€™t happen</button>
          `: ''}
        </div>
      `;
      return card;
    }

    function renderQuickActions(container){
      container.innerHTML = '';
      const opts = buildQuickTimes();
      opts.forEach(opt=>{
        const b = document.createElement('button');
        b.className = 'pill'; b.type = 'button'; b.textContent = opt.label;
        b.onclick = ()=>{ openSwapModal(currentConversationUserId, targetUserData?.displayName||targetUserData?.name||'User');
          // Prefill
          qs('#swapDate').value = opt.date; qs('#swapStartTime').value = opt.start; qs('#swapDuration').value = String(opt.minutes);
          qs('#swapDescription').value = 'Skill swap session'; };
        container.appendChild(b);
      });
    }

    function buildQuickTimes(){
      const out = []; const now = new Date();
      const plus1 = new Date(now.getTime()+60*60*1000);
      if(plus1.getHours() < 21){ out.push({ label:`Today ${plus1.toTimeString().slice(0,5)}`, date: plus1.toISOString().split('T')[0], start: plus1.toTimeString().slice(0,5), minutes:60 }); }
      const t = new Date(now); t.setDate(t.getDate()+1); t.setHours(18,0,0,0);
      out.push({ label:`Tomorrow 18:00`, date: t.toISOString().split('T')[0], start:'18:00', minutes:60 });
      const sat = new Date(now); sat.setDate(now.getDate()+((6-now.getDay()+7)%7||7)); sat.setHours(10,0,0,0);
      out.push({ label:`${sat.toLocaleDateString(undefined,{weekday:'short'})} 10:00`, date: sat.toISOString().split('T')[0], start:'10:00', minutes:60 });
      return out;
    }

    function setupComposer(formEl){
      const input = qs('#messageInput'); const send = qs('#sendBtn');
      formEl.onsubmit = (e)=>{
        e.preventDefault(); const text = input.value.trim(); if(!text) return; send.disabled = true;
        const convoId = makeConversationId(currentUserId, currentConversationUserId);
        const toName = targetUserData?.displayName || targetUserData?.name || 'User';
        const fromName = currentUserData?.displayName || currentUserData?.name || 'You';
        db.collection('messages').add({
          conversationId: convoId,
          participants: [currentUserId, currentConversationUserId],
          from: currentUserId, to: currentConversationUserId, fromName, toName,
          text, timestamp: firebase.firestore.FieldValue.serverTimestamp(), read: false
        }).then(()=>{ input.value=''; send.disabled=false; input.focus(); })
          .catch(err=>{ console.error(err); send.disabled=false; alert('Failed to send'); });
      };
    }

    async function markMessagesAsRead(msgs){
      if(!msgs.length) return;
      const batch = db.batch();
      msgs.forEach(m=>{ const ref = db.collection('messages').doc(m.id); batch.update(ref, { read:true }); });
      try{ await batch.commit(); }catch(e){ console.warn('mark read', e); }
    }

    // --- Swap modal (lightweight) ---
    function openSwapModal(targetUserId, targetUserName){
      const modal = qs('#modalRoot'); modal.style.display = 'block';
      modal.innerHTML = `
        <div class="modal-content">
          <div class="modal-header">Propose a Swap with ${targetUserName}</div>
          <div class="modal-body">
            <form id="swapForm">
              <div class="form-group">
                <label for="swapDescription">What will you swap?</label>
                <input id="swapDescription" type="text" placeholder="e.g., Teach beginner guitar â†” Learn basic cooking" required />
              </div>
              <div class="form-group">
                <label for="swapDate">Date</label>
                <input type="date" id="swapDate" required />
              </div>
              <div style="display:flex; gap:10px;">
                <div class="form-group" style="flex:1">
                  <label for="swapStartTime">Start Time</label>
                  <input type="time" id="swapStartTime" required />
                </div>
                <div class="form-group" style="flex:1">
                  <label for="swapDuration">Duration</label>
                  <select id="swapDuration" required>
                    <option value="30">30 min</option>
                    <option value="45">45 min</option>
                    <option value="60" selected>60 min</option>
                  </select>
                </div>
              </div>
              <div class="form-group">
                <label for="swapMode">Mode</label>
                <select id="swapMode" required>
                  <option value="online" selected>Online (link in chat)</option>
                  <option value="in_person">In person</option>
                </select>
              </div>
              <div class="form-group" id="locationGroup" style="display:none">
                <label for="swapLocation">Location (if in person)</label>
                <input type="text" id="swapLocation" placeholder="Cafe on Queen St" />
              </div>
              <div class="form-group">
                <label>Balance</label>
                <div style="display:flex; gap:10px;">
                  <label><input type="radio" name="swapType" value="reciprocal" checked /> Balanced (free)</label>
                  <label><input type="radio" name="swapType" value="paid" /> Paid</label>
                </div>
              </div>
              <div class="form-group" id="priceGroup" style="display:none">
                <label for="paymentAmount">Price (USD)</label>
                <input type="number" id="paymentAmount" min="5" step="1" placeholder="20" />
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button class="btn btn-cancel" onclick="closeSwapModal()">Cancel</button>
            <button class="btn btn-create" onclick="createSwap('${targetUserId}', '${targetUserName}')">Send Proposal</button>
          </div>
        </div>`;

      // Defaults
      const tomorrow = new Date(); tomorrow.setDate(tomorrow.getDate()+1);
      qs('#swapDate').value = tomorrow.toISOString().split('T')[0];
      const now = new Date(); now.setHours(now.getHours()+1,0,0,0);
      qs('#swapStartTime').value = now.toTimeString().slice(0,5);

      const modeEl = qs('#swapMode'); const locationGroup = qs('#locationGroup');
      modeEl.addEventListener('change', ()=>{ locationGroup.style.display = modeEl.value==='in_person' ? 'block' : 'none'; });
      document.querySelectorAll('input[name="swapType"]').forEach(r=> r.addEventListener('change', ()=>{
        qs('#priceGroup').style.display = (document.querySelector('input[name="swapType"]:checked').value==='paid') ? 'block' : 'none';
      }));
    }
    function closeSwapModal(){ const modal = qs('#modalRoot'); modal.style.display='none'; modal.innerHTML = ''; }

    async function createSwap(targetUserId, targetUserName){
      const user = auth.currentUser; if(!user){ alert('Sign in to create a swap.'); return; }
      const date = qs('#swapDate').value;
      const startTime = qs('#swapStartTime').value;
      const minutes = parseInt(qs('#swapDuration').value,10);
      const mode = qs('#swapMode').value;
      const location = qs('#swapLocation')?.value || '';
      const description = qs('#swapDescription').value.trim();
      const swapType = document.querySelector('input[name="swapType"]:checked').value;
      const priceUSD = swapType==='paid' ? parseInt((qs('#paymentAmount').value||'0'),10) : 0;
      if(!date || !startTime || !minutes || !description){ alert('Please complete all required fields.'); return; }
      const startISO = new Date(`${date}T${startTime}:00`); const endISO = new Date(startISO.getTime()+minutes*60000);

      // Names
      const [fromDoc,toDoc] = await Promise.all([
        db.collection('users').doc(user.uid).get(), db.collection('users').doc(targetUserId).get()
      ]);
      const fromName = fromDoc.exists ? (fromDoc.data().displayName || fromDoc.data().name || user.email) : (user.email || 'User');
      const toName = toDoc.exists ? (toDoc.data().displayName || toDoc.data().name || 'User') : 'User';

      // Create swap
      const swapRef = await db.collection('swaps').add({
        from: user.uid, to: targetUserId, fromName, toName,
        description, mode, location,
        startTime: firebase.firestore.Timestamp.fromDate(startISO),
        endTime: firebase.firestore.Timestamp.fromDate(endISO),
        duration_mins: minutes,
        swap_type: swapType,
        price_cents: priceUSD? priceUSD*100 : 0,
        status: 'proposed', createdAt: firebase.firestore.FieldValue.serverTimestamp()
      });

      // Notify in chat
      const convoId = makeConversationId(user.uid, targetUserId);
      await db.collection('messages').add({
        conversationId: convoId,
        participants: [user.uid, targetUserId],
        from: user.uid, to: targetUserId, fromName, toName,
        type: 'swap_request', swapId: swapRef.id,
        text: `Proposed: ${description} on ${startISO.toLocaleString()} (${minutes} min, ${mode==='online'?'online':(location||'in person')})`,
        timestamp: firebase.firestore.FieldValue.serverTimestamp(), read:false
      });

      closeSwapModal(); alert('Swap proposal sent!');
    }

    // --- Swap responses ---
    async function respondToSwap(swapId, response){
      const user = auth.currentUser; if(!user) return;
      const ref = db.collection('swaps').doc(swapId); const doc = await ref.get(); if(!doc.exists){ alert('Swap not found.'); return; }
      const s = doc.data(); if(s.to !== user.uid){ alert('Only the recipient can respond.'); return; }
      if(s.status !== 'proposed'){ alert('This swap was already handled.'); return; }
      const newStatus = (response === 'accepted') ? 'confirmed' : 'declined';
      await ref.update({ status: newStatus, respondedAt: firebase.firestore.FieldValue.serverTimestamp() });
      await db.collection('messages').add({
        conversationId: makeConversationId(s.from, s.to),
        participants:[s.from, s.to],
        from: user.uid, to: s.from,
        fromName: s.toName, toName: s.fromName,
        type:'swap_response', swapId,
        response,
        text: `Your swap request for ${s.description} on ${s.startTime.toDate().toLocaleString()} was ${response}.`,
        timestamp: firebase.firestore.FieldValue.serverTimestamp(), read:false
      });
      alert(`Swap ${response}.`);
    }

    function suggestAnotherTime(swapId, otherUserId, otherUserName){
      openSwapModal(otherUserId, otherUserName||'User');
      // preload existing details
      db.collection('swaps').doc(swapId).get().then(doc=>{
        if(doc.exists){ const s=doc.data();
          if(s.description) qs('#swapDescription').value = s.description;
          if(s.mode){ qs('#swapMode').value = s.mode; if(s.mode==='in_person'){ qs('#locationGroup').style.display='block'; qs('#swapLocation').value = s.location||''; }}
        }
      });
    }

    async function completeSwap(swapId){ await db.collection('swaps').doc(swapId).update({ status:'completed', completedAt: firebase.firestore.FieldValue.serverTimestamp() }); alert('Great! Swap marked as completed.'); }
    async function flagNoShow(swapId){ await db.collection('swaps').doc(swapId).update({ status:'incomplete', incompleteReason:'no_show', updatedAt: firebase.firestore.FieldValue.serverTimestamp() }); alert('Marked as didnâ€™t happen.'); }
  </script>
</body>
</html>













